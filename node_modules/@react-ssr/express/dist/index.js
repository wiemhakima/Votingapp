"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var express=_interopDefault(require("express")),path=require("path"),path__default=_interopDefault(path),http=_interopDefault(require("http")),React=_interopDefault(require("react")),ReactDOMServer=_interopDefault(require("react-dom/server")),cheerio=_interopDefault(require("cheerio")),ReactHtmlParser=_interopDefault(require("react-html-parser")),fs=require("fs"),fs__default=_interopDefault(fs),readdir=_interopDefault(require("recursive-readdir")),fse=_interopDefault(require("fs-extra")),MemoryFileSystem=_interopDefault(require("memory-fs")),webpack=_interopDefault(require("webpack")),webpackMerge=require("webpack-merge"),TerserPlugin=_interopDefault(require("terser-webpack-plugin"));function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(r,!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(r).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var r,s,n={},c=Object.keys(e);for(s=0;s<c.length;s++)r=c[s],t.indexOf(r)>=0||(n[r]=e[r]);return n}function _objectWithoutProperties(e,t){if(null==e)return{};var r,s,n=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(s=0;s<c.length;s++)r=c[s],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}const getSsrId=e=>{let t="default";return 0<=e.indexOf('"mui')&&(t="material-ui"),0<=e.indexOf("data-emotion-css")&&(t="emotion"),0<=e.indexOf('"views__')&&(t="styled-components"),t},convertAttrToJsxStyle=e=>{const t={},r=Object.keys(e);for(let s=0;s<r.length;s++){let n=r[s];"class"===n&&(n="className"),0<=n.indexOf("-")&&(n.startsWith("data-")||(n=n.replace(/-([a-z])/g,e=>e[1].toUpperCase()))),t[n]=e[r[s]]}return t};var SSR=e=>{const{children:t,script:r}=e,s=ReactDOMServer.renderToStaticMarkup(React.createElement(React.Fragment,null,t)).toLowerCase(),n=0<=s.indexOf("html"),c=getSsrId(s);switch(c){case"material-ui":{const{ServerStyleSheets:e}=require("@material-ui/core/styles"),s=new e;if(n){const e=ReactDOMServer.renderToStaticMarkup(s.collect(React.cloneElement(t,{script:`${r}&ssrid=${c}`}))),n=cheerio.load(e),a=n("html").attr(),o=n("body").attr(),l=n("head").html(),i=n("body").html();return React.createElement("html",convertAttrToJsxStyle(a),React.createElement("head",null,l?ReactHtmlParser(l):null,s.getStyleElement()),React.createElement("body",convertAttrToJsxStyle(o),i?ReactHtmlParser(i):null,React.createElement("script",{id:"react-ssr-script",src:`${r}&ssrid=${c}`}),"production"===process.env.NODE_ENV?null:React.createElement("script",{src:"/reload/reload.js"})))}{const e=ReactDOMServer.renderToStaticMarkup(s.collect(t));return React.createElement("html",null,React.createElement("head",null,s.getStyleElement()),React.createElement("body",null,React.createElement("div",{id:"react-ssr-root"},ReactHtmlParser(e)),React.createElement("script",{id:"react-ssr-script",src:`${r}&ssrid=${c}`}),"production"===process.env.NODE_ENV?null:React.createElement("script",{src:"/reload/reload.js"})))}}case"styled-components":{const{ServerStyleSheet:e,StyleSheetManager:s}=require("styled-components"),a=new e;let o,l;if(n){try{o=ReactDOMServer.renderToStaticMarkup(React.createElement(s,{sheet:a.instance},React.cloneElement(t,{script:`${r}&ssrid=${c}`}))),l=a.getStyleElement()}catch(e){return console.error(e),React.createElement("html",null,React.createElement("body",null,e))}finally{a.seal()}const e=cheerio.load(o),n=e("html").attr(),i=e("body").attr(),p=e("head").html(),u=e("body").html();return React.createElement("html",convertAttrToJsxStyle(n),React.createElement("head",null,p?ReactHtmlParser(p):null,l),React.createElement("body",convertAttrToJsxStyle(i),u?ReactHtmlParser(u):null,React.createElement("script",{id:"react-ssr-script",src:`${r}&ssrid=${c}`}),"production"===process.env.NODE_ENV?null:React.createElement("script",{src:"/reload/reload.js"})))}try{o=ReactDOMServer.renderToStaticMarkup(React.createElement(s,{sheet:a.instance},t)),l=a.getStyleElement()}catch(e){return console.error(e),React.createElement("html",null,React.createElement("body",null,e))}finally{a.seal()}return React.createElement("html",null,React.createElement("head",null,l),React.createElement("body",null,React.createElement("div",{id:"react-ssr-root"},ReactHtmlParser(o)),React.createElement("script",{id:"react-ssr-script",src:`${r}&ssrid=${c}`}),"production"===process.env.NODE_ENV?null:React.createElement("script",{src:"/reload/reload.js"})))}default:return n?React.cloneElement(t,{script:`${r}&ssrid=${c}`}):React.createElement("html",null,React.createElement("body",null,React.createElement("div",{id:"react-ssr-root"},t),React.createElement("script",{id:"react-ssr-script",src:`${r}&ssrid=${c}`}),"production"===process.env.NODE_ENV?null:React.createElement("script",{src:"/reload/reload.js"})))}};const cwd=process.cwd(),getEngine=()=>fs.existsSync(path.join(cwd,"tsconfig.json"))?"tsx":"jsx",hasUserBabelrc=()=>fs.existsSync(path.join(cwd,".babelrc"))||fs.existsSync(path.join(cwd,".babelrc.js"))||fs.existsSync(path.join(cwd,"babel.config.js")),getBabelrc=()=>fs.existsSync(path.join(cwd,".babelrc"))?path.join(cwd,".babelrc"):fs.existsSync(path.join(cwd,".babelrc.js"))?path.join(cwd,".babelrc.js"):fs.existsSync(path.join(cwd,"babel.config.js"))?path.join(cwd,"babel.config.js"):path.resolve(__dirname,"../babel.config.default.js"),getBabelRule=()=>({test:/\.(js|ts)x?$/,exclude:/node_modules/,use:{loader:"babel-loader",options:{cacheDirectory:!0,extends:getBabelrc()}}}),getBabelPresetsAndPlugins=()=>{return{presets:["@babel/preset-env","@babel/preset-react","@babel/preset-typescript"],plugins:["babel-plugin-react-require","babel-plugin-css-modules-transform","@babel/plugin-syntax-dynamic-import","@babel/plugin-proposal-class-properties",["@babel/plugin-proposal-object-rest-spread",{useBuiltIns:!0}],["@babel/plugin-transform-runtime",{corejs:2,helpers:!0,regenerator:!0,useESModules:!1}]]}},gracefullyShutDown=async e=>{let t=!1;const r=()=>{if(!t){t=!0;const r=require("resolve-as-bin"),s=require("cross-spawn"),n=e();s.sync(r("fkill"),["-f",`:${n}`],{cwd:cwd,stdio:"inherit"})}};process.on("SIGINT",r),process.on("SIGTERM",r),process.on("exit",r)},ignores=[".*","*.json","*.lock","*.md","*.txt","*.yml","LICENSE"],ignoreDotDir=(e,t)=>t.isDirectory()&&path.basename(e).startsWith("."),ignoreNodeModules=(e,t)=>t.isDirectory()&&"node_modules"==path.basename(e),getPages=async e=>{const t=await readdir(cwd,[ignoreNodeModules,ignoreDotDir,...ignores]),r=await readdir(path.join(cwd,e.viewsDir),[ignoreDotDir,...ignores]),s=[];for(let e=0;e<t.length;e++){const n=t[e];r.includes(n)||s.push(n)}return[r,s]},getPageId=(e,t,r="_")=>{const[,...s]=e.replace(path.join(cwd,t.viewsDir),"").replace(path.extname(e),"").split(path.sep);return s.join(r)},readFileWithProps=(e,t)=>fs.readFileSync(e).toString().replace("__REACT_SSR_PROPS__",JSON.stringify(t).replace(/"/g,'\\"')),sleep=e=>new Promise(t=>setTimeout(t,e)),codec=require("json-url")("lzw");require("@babel/register")(_objectSpread2({extensions:[".js",".jsx",".ts",".tsx"]},{presets:["@babel/preset-env","@babel/preset-react","@babel/preset-typescript"],plugins:["babel-plugin-react-require","babel-plugin-css-modules-transform","@babel/plugin-syntax-dynamic-import","@babel/plugin-proposal-class-properties",["@babel/plugin-proposal-object-rest-spread",{useBuiltIns:!0}],["@babel/plugin-transform-runtime",{corejs:2,helpers:!0,regenerator:!0,useESModules:!1}]]}));const render=async(e,t,r)=>{let s=require(e);s=s.default||s;let n="<!DOCTYPE html>";return n+=ReactDOMServer.renderToStaticMarkup(React.createElement(SSR,{script:`/_react-ssr/${getPageId(e,r,"/")}.js?props=${await codec.compress(t)}`},React.createElement(s,t)))},cwd$1=process.cwd(),env="production"===process.env.NODE_ENV?"production":"development",prodConfig={performance:{hints:"warning"},output:{pathinfo:!1},optimization:{namedModules:!1,namedChunks:!1,flagIncludedChunks:!0,occurrenceOrder:!0,sideEffects:!0,usedExports:!0,concatenateModules:!0,splitChunks:{minSize:3e4,maxAsyncRequests:5,maxInitialRequests:3},minimize:!0,minimizer:[new TerserPlugin]},plugins:[new webpack.optimize.ModuleConcatenationPlugin]},getUserWebpack=()=>{const e=path__default.join(cwd$1,"ssr.config.js");return fs__default.existsSync(e)?require(e).webpack:void 0};var configure=(e,t)=>{"development"===env&&hasUserBabelrc()&&console.log(`[ info ] custom babelrc in: ${getBabelrc()}`);let r={mode:"development",context:cwd$1,entry:e,output:{path:path__default.join(cwd$1,t,env),filename:"[name].js"},resolve:{extensions:[".js",".jsx",".ts",".tsx"]},module:{rules:[getBabelRule()]},optimization:{nodeEnv:"production"},plugins:[new webpack.DefinePlugin({"process.env.NODE_ENV":JSON.stringify("production")})]};"production"===env&&(r=webpackMerge.smart(r,prodConfig));const s=getUserWebpack();return s&&("function"==typeof s?r=s(r,env):console.warn("[ warn ] ssr.config.js#webpack must be a function")),r};const cwd$2=process.cwd(),env$1="production"===process.env.NODE_ENV?"production":"development",ext="."+getEngine(),codec$1=require("json-url")("lzw"),ufs=require("unionfs").ufs,memfs=new MemoryFileSystem;async function bundle(e,t,r,s){const n={},[c,a]=await getPages(e),o=fse.readFileSync(path__default.join(__dirname,"../entry.js")).toString();for(let t=0;t<c.length;t++){const s=c[t],a=getPageId(s,e,"/"),l=path__default.dirname(a),i=path__default.basename(a);"."!==l&&r.mkdirpSync(path__default.join(cwd$2,`react-ssr-src/${l}`)),r.writeFileSync(path__default.join(cwd$2,`react-ssr-src/${path__default.join(l,`entry-${i}${ext}`)}`),o.replace("__REACT_SSR_PAGE_NAME__",i)),r.writeFileSync(path__default.join(cwd$2,`react-ssr-src/${path__default.join(l,i+ext)}`),fse.readFileSync(s)),n[getPageId(s,e,"_")]=`./react-ssr-src/${path__default.join(l,`entry-${i}${ext}`)}`}for(let t=0;t<a.length;t++){const s=a[t],n=getPageId(s,e,"/"),c=path__default.dirname(n),o=path__default.basename(n);"."!==c&&r.mkdirpSync(path__default.join(cwd$2,`react-ssr-src/${c}`)),r.writeFileSync(path__default.join(cwd$2,`react-ssr-src/${path__default.join(c,o+ext)}`),fse.readFileSync(s))}let l=!1;const i=configure(n,e.cacheDir),p=webpack(i);for(p.inputFileSystem=t,p.run(async t=>{if(t&&console.error(t.stack||t),s)for(let t=0;t<c.length;t++){const r=c[t],n=getPageId(r,e,"/"),a=`/_react-ssr/${n}.js`;console.log(`[ info ] optimized "${e.viewsDir}/${n}${ext}"`),s.get(a,async(t,s)=>{const n=await codec$1.decompress(t.query.props);"development"===env$1&&(console.log("[ info ] the props below is rendered from the server side"),console.log(n));const c=path__default.join(cwd$2,e.cacheDir,env$1,`${getPageId(r,e,"_")}.js`),a=readFileWithProps(c,n);s.type(".js").send(a)})}l=!0});!l;)await sleep(100)}ufs.use(fs__default).use(memfs);var optimize=async(e,t,r)=>{let s=!1;if("development"===env$1){const t=require("reload");s=await t(e)}if(fse.removeSync(path__default.join(cwd$2,r.cacheDir)),memfs.mkdirpSync(path__default.join(cwd$2,"react-ssr-src")),await bundle(r,ufs,memfs,e),"development"===env$1){const e=require("lodash.escaperegexp"),t=require("chokidar").watch(cwd$2,{ignored:[/node_modules/i,/package\.json/i,/readme\.md/i,new RegExp(e(r.cacheDir))]}),n=()=>{t.close()};process.on("SIGINT",n),process.on("SIGTERM",n),process.on("exit",n),t.on("change",async e=>{fse.removeSync(path__default.join(cwd$2,r.cacheDir)),await bundle(r,ufs,memfs),s.reload();const[,...t]=e.replace(cwd$2,"").split(path.sep);console.log(`[ info ] reloaded (onchange: ${t.join("/")})`)}),console.log("[ info ] enabled hot reloading")}return gracefullyShutDown(()=>(console.log("[ info ] gracefully shutting down. please wait..."),process.on("SIGINT",()=>{process.exit(0)}),t.address().port)),t};class Config{constructor(){_defineProperty(this,"viewsDir","views"),_defineProperty(this,"cacheDir",".cache")}}const escaperegexp=require("lodash.escaperegexp");let moduleDetectRegEx;const register=async(e,t)=>{const r=Object.assign(new Config,t||{}),s=getEngine();e.engine(s,async(e,t,s)=>{if(!moduleDetectRegEx){const e=[].concat(t.settings.views).map(e=>"^"+escaperegexp(e)).join("|");moduleDetectRegEx=new RegExp(e)}const n=_objectWithoutProperties(t,["settings","cache","_locals"]);try{return s(void 0,await render(e,n,r))}catch(e){return s(e)}finally{Object.keys(require.cache).forEach(e=>{moduleDetectRegEx.test(e)&&delete require.cache[e]})}}),e.set("views",path__default.join(process.cwd(),r.viewsDir)),e.set("view engine",s),e.listen=function(){const t=arguments,s=http.createServer(e);return optimize(e,s,r).then(e=>{e.listen.apply(e,t)}),s}};function ReactSsrExpress(e){const t=express();return register(t,e),t}module.exports=ReactSsrExpress;
